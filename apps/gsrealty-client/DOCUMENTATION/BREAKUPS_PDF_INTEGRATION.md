# Break-ups PDF Generator Integration Guide

**Project:** GSRealty Client Management System - ReportIt Feature
**Purpose:** Integration guide for PDF generator with ReportIt pipeline
**Created:** October 29, 2024
**Version:** 1.0

---

## Integration Overview

The PDF generator is the **third agent** in the ReportIt break-ups pipeline:

```
┌─────────────────────┐
│  1. ANALYZER AGENT  │
│  breakups-analyzer  │
└──────────┬──────────┘
           │ BreakupsAnalysisResult
           ↓
┌──────────────────────┐
│ 2. VISUALIZER AGENT  │
│ breakups-visualizer  │
└──────────┬───────────┘
           │ PNG chart files
           ↓
┌────────────────────────┐
│ 3. PDF GENERATOR AGENT │  ← NEW
│ breakups-pdf-generator │
└──────────┬─────────────┘
           │ 5 PDF reports
           ↓
┌─────────────────────┐
│  4. PACKAGER AGENT  │
│  breakups-packager  │
└─────────────────────┘
```

---

## Integration Points

### 1. With Analyzer Agent

**Input Required:** `BreakupsAnalysisResult`

The PDF generator expects the complete analysis result object from `breakups-analyzer.ts`:

```typescript
// In breakups-analyzer.ts
export interface BreakupsAnalysisResult {
  analysisDate: string;
  propertyCount: number;
  subjectProperty: {
    address: string;
    apn?: string;
    price?: number;
    sqft?: number;
    bedrooms?: number;
    bathrooms?: number;
  };
  analyses: AnalysisItem[];
  summary: {
    overallConfidence: number;
    dataQuality: string;
    recommendedValue?: number;
    valueRange?: { low: number; high: number };
  };
}
```

**Ensure Compatibility:**
- All 22 analyses present in `analyses` array
- Each `AnalysisItem` has `id`, `name`, `category`, `results`, `insight`
- `summary` includes confidence and data quality metrics

---

### 2. With Visualizer Agent

**Input Required:** Chart PNG file paths

The PDF generator needs PNG chart files generated by `breakups-visualizer.ts`:

```typescript
// Expected chart naming convention
const chartPaths = [
  '/tmp/reportit/breakups/{fileId}/charts/01_br_distribution.png',
  '/tmp/reportit/breakups/{fileId}/charts/02_hoa_comparison.png',
  '/tmp/reportit/breakups/{fileId}/charts/03_str_analysis.png',
  // ... (all 22 charts)
];
```

**Chart Requirements:**
- **Format**: PNG (300 DPI recommended)
- **Size**: 1920x1080 pixels ideal
- **Naming**: `{id}__{name}.png` format
- **Location**: All in same directory

**Chart Mapping:**
The PDF generator automatically maps chart IDs from filenames:
```typescript
// Extracts ID from "01_br_distribution.png" → 1
const chartMap = mapChartsToAnalyses(chartPaths);
```

---

### 3. With Packager Agent

**Output Provided:** 5 PDF files

The packager agent consumes PDF files for ZIP packaging:

```typescript
// In breakups-packager.ts
const pdfFiles = [
  'Executive_Summary.pdf',
  'Property_Characteristics.pdf',
  'Market_Analysis.pdf',
  'Financial_Analysis.pdf',
  'Market_Activity.pdf',
];

// Add to ZIP in reports/ folder
pdfFiles.forEach(pdf => {
  zip.folder('reports').file(pdf, fs.readFileSync(path.join(reportsDir, pdf)));
});
```

---

## Complete Integration Example

### Main Orchestrator Function

```typescript
/**
 * Complete ReportIt break-ups generation pipeline
 */
async function generateBreakupsReport(fileId: string, data: any) {
  const baseDir = `/tmp/reportit/breakups/${fileId}`;
  const chartsDir = path.join(baseDir, 'charts');
  const reportsDir = path.join(baseDir, 'reports');

  try {
    // STEP 1: Analyze data (22 analyses)
    console.log('Step 1: Running break-ups analysis...');
    const analysisResults = await analyzeBreakups(data);
    console.log(`✓ Analyzed ${analysisResults.propertyCount} properties`);
    console.log(`✓ Generated ${analysisResults.analyses.length} analyses`);

    // STEP 2: Generate visualizations (22 PNG charts)
    console.log('\nStep 2: Generating visualizations...');
    const visualizationResults = await generateVisualizationsAgent(
      analysisResults,
      chartsDir
    );
    console.log(`✓ Generated ${visualizationResults.chartPaths.length} charts`);

    // STEP 3: Generate PDF reports (5 PDFs) ← NEW
    console.log('\nStep 3: Generating PDF reports...');
    const pdfResults = await generateAllPDFReports(
      analysisResults,
      visualizationResults.chartPaths,
      reportsDir
    );

    if (!pdfResults.success) {
      throw new Error(`PDF generation failed: ${pdfResults.errors.join(', ')}`);
    }

    console.log(`✓ Generated ${pdfResults.generatedFiles.length} PDF reports`);
    console.log(`✓ Total PDF size: ${(pdfResults.totalSize / 1024 / 1024).toFixed(2)} MB`);
    console.log(`✓ Generation time: ${(pdfResults.generationTime / 1000).toFixed(2)}s`);

    // STEP 4: Package everything into ZIP
    console.log('\nStep 4: Creating ZIP package...');
    const zipResults = await createBreakupsZipPackage({
      fileId,
      analysisResults,
      chartPaths: visualizationResults.chartPaths,
      pdfFiles: pdfResults.generatedFiles,
      outputDir: baseDir,
    });

    console.log(`✓ ZIP package created: ${zipResults.zipPath}`);
    console.log(`✓ Total package size: ${(zipResults.size / 1024 / 1024).toFixed(2)} MB`);

    return {
      success: true,
      fileId,
      zipPath: zipResults.zipPath,
      zipSize: zipResults.size,
      analyses: analysisResults.analyses.length,
      charts: visualizationResults.chartPaths.length,
      pdfs: pdfResults.generatedFiles.length,
      totalTime: Date.now() - startTime,
    };
  } catch (error) {
    console.error('Pipeline error:', error);
    throw error;
  }
}
```

---

## API Route Integration

### Example: `/api/admin/reportit/generate/breakups`

```typescript
// app/api/admin/reportit/generate/breakups/route.ts
import { NextRequest, NextResponse } from 'next/server';
import { generateAllPDFReports } from '@/lib/processing/breakups-pdf-generator';
import { analyzeBreakups } from '@/lib/processing/breakups-analyzer';
import { generateVisualizationsAgent } from '@/lib/processing/breakups-visualizer';

export async function POST(req: NextRequest) {
  try {
    const { fileId, data } = await req.json();

    // Validate input
    if (!fileId || !data) {
      return NextResponse.json(
        { error: 'Missing fileId or data' },
        { status: 400 }
      );
    }

    // Define directories
    const baseDir = `/tmp/reportit/breakups/${fileId}`;
    const chartsDir = `${baseDir}/charts`;
    const reportsDir = `${baseDir}/reports`;

    // Run pipeline
    const analysisResults = await analyzeBreakups(data);
    const visualizationResults = await generateVisualizationsAgent(
      analysisResults,
      chartsDir
    );
    const pdfResults = await generateAllPDFReports(
      analysisResults,
      visualizationResults.chartPaths,
      reportsDir
    );

    // Check for errors
    if (!pdfResults.success) {
      return NextResponse.json(
        {
          success: false,
          errors: pdfResults.errors,
          partialResults: pdfResults.generatedFiles,
        },
        { status: 500 }
      );
    }

    // Return success
    return NextResponse.json({
      success: true,
      fileId,
      pdfs: pdfResults.generatedFiles.map(p => path.basename(p)),
      totalSize: pdfResults.totalSize,
      generationTime: pdfResults.generationTime,
    });
  } catch (error) {
    console.error('Error generating PDFs:', error);
    return NextResponse.json(
      { error: 'Internal server error' },
      { status: 500 }
    );
  }
}
```

---

## Error Handling Strategy

### Graceful Degradation

The PDF generator is designed to continue even if individual reports fail:

```typescript
const result = await generateAllPDFReports(analysisResults, chartPaths, outputDir);

if (!result.success) {
  // Some PDFs failed, but others may have succeeded
  console.error('Errors:', result.errors);

  if (result.generatedFiles.length > 0) {
    // Continue with partial results
    console.log(`Partial success: ${result.generatedFiles.length} PDFs generated`);
    // Include these in ZIP package anyway
  } else {
    // Total failure - abort pipeline
    throw new Error('PDF generation completely failed');
  }
}
```

### Missing Charts Handling

PDFs will still generate even if charts are missing:

```typescript
// Missing chart shows placeholder text
embedChart(doc, chartPath, options);
// If file doesn't exist: "[Chart not available]"
```

---

## Testing Integration

### Unit Test: Pipeline Integration

```typescript
// __tests__/breakups-pipeline.test.ts
import { generateBreakupsReport } from '@/lib/processing/breakups-orchestrator';

describe('Break-ups Pipeline Integration', () => {
  it('generates complete report package', async () => {
    const fileId = 'test-123';
    const mockData = {
      // ... test data
    };

    const result = await generateBreakupsReport(fileId, mockData);

    expect(result.success).toBe(true);
    expect(result.pdfs).toBe(5);
    expect(result.charts).toBe(22);
    expect(result.zipPath).toContain('test-123');
  });

  it('handles partial PDF generation failures', async () => {
    // Test with invalid analysis data
    const result = await generateBreakupsReport('test-456', invalidData);

    // Should still complete with warnings
    expect(result.success).toBe(true);
    expect(result.pdfs).toBeGreaterThan(0); // At least some PDFs
  });
});
```

---

## Performance Optimization

### Parallel Chart Generation (Future)

Currently charts generate sequentially. For optimization:

```typescript
// Generate charts in parallel (visualizer agent)
const chartPromises = analyses.map(analysis =>
  generateChart(analysis, chartsDir)
);
const chartPaths = await Promise.all(chartPromises);

// Then generate PDFs sequentially (uses charts)
const pdfResult = await generateAllPDFReports(
  analysisResults,
  chartPaths,
  reportsDir
);
```

### Caching Strategy

For repeated generations of same property:

```typescript
// Check cache before generating
const cacheKey = `${fileId}-${hash(analysisResults)}`;
const cachedPDFs = await getCachedPDFs(cacheKey);

if (cachedPDFs) {
  return cachedPDFs; // Skip generation
}

// Generate and cache
const pdfResult = await generateAllPDFReports(...);
await cachePDFs(cacheKey, pdfResult.generatedFiles);
```

---

## Directory Structure

### Complete File Layout

```
/tmp/reportit/breakups/{fileId}/
├── charts/                          (from visualizer)
│   ├── 01_br_distribution.png
│   ├── 02_hoa_comparison.png
│   └── ... (22 total)
│
├── reports/                         (from PDF generator) ← NEW
│   ├── Executive_Summary.pdf
│   ├── Property_Characteristics.pdf
│   ├── Market_Analysis.pdf
│   ├── Financial_Analysis.pdf
│   └── Market_Activity.pdf
│
├── data/                            (from packager)
│   ├── raw_mls_data.csv
│   ├── mcao_response.json
│   ├── breakups_results.json
│   └── metadata.json
│
├── Complete_ReportIt_{name}.xlsx   (from packager)
└── Break-ups-{name}.zip            (final output)
```

---

## Type Compatibility

### Shared Types

Ensure these types are consistent across agents:

```typescript
// In lib/types/breakups.ts (shared)
export interface BreakupsAnalysisResult {
  // Same across analyzer, visualizer, PDF generator
}

export interface AnalysisItem {
  // Same structure
  id: number;
  name: string;
  category: 'A' | 'B' | 'C' | 'D' | 'E';
  results: any;
  insight: string;
  chartPath?: string; // Added by visualizer
}
```

---

## Deployment Considerations

### Server Requirements

- **Node.js**: 18.17.0+
- **Memory**: 512 MB minimum (for PDF generation)
- **Disk**: 50 MB temporary space per report
- **CPU**: 1 core sufficient

### Environment Variables

No additional environment variables required. PDF generator uses:
- `process.env.TMPDIR` (default `/tmp`)
- File system paths from caller

---

## Monitoring & Logging

### Recommended Logging

```typescript
// In orchestrator
console.log('[BREAKUPS] Starting pipeline for', fileId);
console.log('[ANALYZER] Processing', propertyCount, 'properties');
console.log('[VISUALIZER] Generated', chartCount, 'charts');
console.log('[PDF-GEN] Generated', pdfCount, 'PDFs in', time, 'ms');
console.log('[PACKAGER] Created ZIP:', zipSize, 'MB');
```

### Error Tracking

```typescript
// Track errors by agent
const errors = {
  analyzer: [],
  visualizer: [],
  pdfGenerator: pdfResult.errors,
  packager: [],
};

// Report to monitoring service
await reportPipelineMetrics({
  fileId,
  success: allAgentsSucceeded,
  errors,
  timing: { analyzer: t1, visualizer: t2, pdfGen: t3, packager: t4 },
});
```

---

## Troubleshooting

### Issue: PDFs generated but not showing in ZIP

**Diagnosis:**
```bash
ls -lh /tmp/reportit/breakups/{fileId}/reports/
# Check if PDFs exist
```

**Solution:**
Ensure packager is reading from correct directory:
```typescript
const reportsDir = path.join(baseDir, 'reports');
const pdfFiles = fs.readdirSync(reportsDir).filter(f => f.endsWith('.pdf'));
```

---

### Issue: Charts not appearing in PDFs

**Diagnosis:**
```typescript
const chartMap = mapChartsToAnalyses(chartPaths);
console.log('Chart map:', chartMap);
// Check if IDs are correctly extracted
```

**Solution:**
Verify chart naming convention:
- Must be: `{id}__{name}.png`
- ID must be 1-22

---

### Issue: PDF generation timing out

**Solution:**
Generate PDFs sequentially, not in parallel:
```typescript
// Don't do this:
// await Promise.all([gen1, gen2, gen3, gen4, gen5]);

// Do this:
await gen1();
await gen2();
await gen3();
await gen4();
await gen5();
```

---

## Next Steps

1. **Test Integration**: Run end-to-end pipeline with test data
2. **Validate Output**: Check all 5 PDFs open correctly
3. **Performance Test**: Measure generation time with real data
4. **Error Handling**: Test with missing/invalid data
5. **Deploy**: Integrate into ReportIt API routes

---

## Related Documentation

- **Main Docs**: `BREAKUPS_PDF_GENERATOR.md`
- **Analyzer**: `REPORTIT_BREAKUPS_ANALYSIS.md`
- **Visualizer**: (to be created)
- **Packager**: `REPORTIT_ZIP_OUTPUT_SPEC.md`

---

**Last Updated**: October 29, 2024
**Version**: 1.0.0
**Status**: Ready for Integration
